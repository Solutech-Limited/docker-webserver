#!/usr/bin/env sh
set -e

if [[ "${LOAD_ENV}" == "1" ]]; then
    cp .env.example .env
    # replace environment variables
    # db variables
    sed -i "s/DB_HOST=/DB_HOST=$DB_HOST/g" .env
    sed -i "s/DB_PORT=/DB_PORT=$DB_PORT/g" .env
    sed -i "s/DB_DATABASE=/DB_DATABASE=$DB_DATABASE/g" .env
    sed -i "s/DB_USERNAME=/DB_USERNAME=$DB_USERNAME/g" .env
    sed -i "s/DB_PASSWORD=/DB_PASSWORD=$DB_PASSWORD/g" .env
    # redis variables
    sed -i "s/REDIS_CLIENT=/REDIS_CLIENT=$REDIS_CLIENT/g" .env
    sed -i "s/REDIS_HOST=/REDIS_HOST=$REDIS_HOST/g" .env
    sed -i "s/REDIS_PASSWORD=/REDIS_PASSWORD=$REDIS_PASSWORD/g" .env
    sed -i "s/REDIS_PORT=/REDIS_PORT=$REDIS_PORT/g" .env
    # sed -i "s/REDIS_CERT_STRING=/REDIS_CERT_STRING=$REDIS_CERT_STRING/g" .env

    # base64 decode redis cert string and create a new file - redis.pem
    echo $REDIS_CERT_STRING | base64 -d > redis.pem

    # cloudflare variables
    sed -i "s/CLOUDFLARE_BASE_URL=/CLOUDFLARE_BASE_URL=$CLOUDFLARE_BASE_URL/g" .env
    sed -i "s/CLOUDFLARE_API_KEY=/CLOUDFLARE_API_KEY=$CLOUDFLARE_API_KEY/g" .env
    sed -i "s/CLOUDFLARE_DEFAULT_BACKEND_IP=/CLOUDFLARE_DEFAULT_BACKEND_IP=$CLOUDFLARE_DEFAULT_BACKEND_IP/g" .env
    sed -i "s/CLOUDFLARE_DEFAULT_FRONTEND_IP=/CLOUDFLARE_DEFAULT_FRONTEND_IP=$CLOUDFLARE_DEFAULT_FRONTEND_IP/g" .env
    sed -i "s/CLOUDFLARE_DEFAULT_BACKEND_DOMAIN=/CLOUDFLARE_DEFAULT_BACKEND_DOMAIN=$CLOUDFLARE_DEFAULT_BACKEND_DOMAIN/g" .env
    sed -i "s/CLOUDFLARE_DEFAULT_FRONTEND_DOMAIN=/CLOUDFLARE_DEFAULT_FRONTEND_DOMAIN=$CLOUDFLARE_DEFAULT_FRONTEND_DOMAIN/g" .env
    sed -i "s/CLOUDFLARE_X_AUTH_EMAIL=/CLOUDFLARE_X_AUTH_EMAIL=$CLOUDFLARE_X_AUTH_EMAIL/g" .env
    sed -i "s/CLOUDFLARE_X_AUTH_KEY=/CLOUDFLARE_X_AUTH_KEY=$CLOUDFLARE_X_AUTH_KEY/g" .env
    # keycloak admin variables
    sed -i "s/KEYCLOAK_BASE_URL=/KEYCLOAK_BASE_URL=$KEYCLOAK_BASE_URL/g" .env
    sed -i "s/KEYCLOAK_ADMIN_USERNAME=/KEYCLOAK_ADMIN_USERNAME=$KEYCLOAK_ADMIN_USERNAME/g" .env
    sed -i "s/KEYCLOAK_ADMIN_PASSWORD=/KEYCLOAK_ADMIN_PASSWORD=$KEYCLOAK_ADMIN_PASSWORD/g" .env
    sed -i "s/KEYCLOAK_DEFAULT_REALM_PUBLIC_KEY=/KEYCLOAK_DEFAULT_REALM_PUBLIC_KEY=$KEYCLOAK_DEFAULT_REALM_PUBLIC_KEY/g" .env
    sed -i "s/KEYCLOAK_CLIENT_SECRET=/KEYCLOAK_CLIENT_SECRET=$KEYCLOAK_CLIENT_SECRET/g" .env
    sed -i "s/KEYCLOAK_CLIENT_ID=/KEYCLOAK_CLIENT_ID=$KEYCLOAK_CLIENT_ID/g" .env
    sed -i "s/KEYCLOAK_DEFAULT_REALM=/KEYCLOAK_DEFAULT_REALM=$KEYCLOAK_DEFAULT_REALM/g" .env
    sed -i "s/ADMIN_HOSTS=/ADMIN_HOSTS=$ADMIN_HOSTS/g" .env
    sed -i "s/KEYCLOAK_REDIRECT_URI=/KEYCLOAK_REDIRECT_URI=$KEYCLOAK_REDIRECT_URI/g" .env
    sed -i "s/KEYCLOAK_REDIRECT_FRONTEND=/KEYCLOAK_REDIRECT_FRONTEND=$KEYCLOAK_REDIRECT_FRONTEND/g" .env

    sed -i "s/SAT_CLIENT_ID=/SAT_CLIENT_ID=$SAT_CLIENT_ID/g" .env
    sed -i "s/SAT_CLIENT_SECRET=/SAT_CLIENT_SECRET=$SAT_CLIENT_SECRET/g" .env
    sed -i "s/SAT_LANDLORD_URL=/SAT_LANDLORD_URL=$SAT_LANDLORD_URL/g" .env

    sed -i "s/GOOGLE_CLOUD_ACCOUNT_TYPE=/GOOGLE_CLOUD_ACCOUNT_TYPE=$GOOGLE_CLOUD_ACCOUNT_TYPE/g" .env
    sed -i "s/GOOGLE_CLOUD_PRIVATE_KEY_ID=/GOOGLE_CLOUD_PRIVATE_KEY_ID=$GOOGLE_CLOUD_PRIVATE_KEY_ID/g" .env
    sed -i "s/GOOGLE_CLOUD_PRIVATE_KEY=/GOOGLE_CLOUD_PRIVATE_KEY=$GOOGLE_CLOUD_PRIVATE_KEY/g" .env
    sed -i "s/GOOGLE_CLOUD_CLIENT_EMAIL=/GOOGLE_CLOUD_CLIENT_EMAIL=$GOOGLE_CLOUD_CLIENT_EMAIL/g" .env
    sed -i "s/GOOGLE_CLOUD_CLIENT_ID=/GOOGLE_CLOUD_CLIENT_ID=$GOOGLE_CLOUD_CLIENT_ID/g" .env
    sed -i "s/GOOGLE_CLOUD_AUTH_URI=/GOOGLE_CLOUD_AUTH_URI=$GOOGLE_CLOUD_AUTH_URI/g" .env
    sed -i "s/GOOGLE_CLOUD_TOKEN_URI=/GOOGLE_CLOUD_TOKEN_URI=$GOOGLE_CLOUD_TOKEN_URI/g" .env
    sed -i "s/GOOGLE_CLOUD_AUTH_PROVIDER_CERT_URL=/GOOGLE_CLOUD_AUTH_PROVIDER_CERT_URL=$GOOGLE_CLOUD_AUTH_PROVIDER_CERT_URL/g" .env
    sed -i "s/GOOGLE_CLOUD_CLIENT_CERT_URL=/GOOGLE_CLOUD_CLIENT_CERT_URL=$GOOGLE_CLOUD_CLIENT_CERT_URL/g" .env

    sed -i "s/GOOGLE_CLOUD_PROJECT_ID=/GOOGLE_CLOUD_PROJECT_ID=$GOOGLE_CLOUD_PROJECT_ID/g" .env
    sed -i "s/GOOGLE_CLOUD_STORAGE_BUCKET=/GOOGLE_CLOUD_STORAGE_BUCKET=$GOOGLE_CLOUD_STORAGE_BUCKET/g" .env
    sed -i "s/GOOGLE_CLOUD_STORAGE_PATH_PREFIX=/GOOGLE_CLOUD_STORAGE_PATH_PREFIX=$GOOGLE_CLOUD_STORAGE_PATH_PREFIX/g" .env
    sed -i "s/GOOGLE_CLOUD_STORAGE_API_URI=/GOOGLE_CLOUD_STORAGE_API_URI=$GOOGLE_CLOUD_STORAGE_API_URI/g" .env
    sed -i "s/GOOGLE_CLOUD_STORAGE_API_ENDPOINT=/GOOGLE_CLOUD_STORAGE_API_ENDPOINT=$GOOGLE_CLOUD_STORAGE_API_ENDPOINT/g" .env

    sed -i "s/GOOGLE_CLOUD_BUCKET_URL=/GOOGLE_CLOUD_BUCKET_URL=$GOOGLE_CLOUD_BUCKET_URL/g" .env

    # mail
    sed -i "s/MAIL_HOST=/MAIL_HOST=$MAIL_HOST/g" .env
    sed -i "s/MAIL_PORT=/MAIL_PORT=$MAIL_PORT/g" .env
    sed -i "s/MAIL_USERNAME=/MAIL_USERNAME=$MAIL_USERNAME/g" .env
    sed -i "s/MAIL_PASSWORD=/MAIL_PASSWORD=$MAIL_PASSWORD/g" .env
    sed -i "s/MAIL_ENCRYPTION=/MAIL_ENCRYPTION=$MAIL_ENCRYPTION/g" .env
    sed -i "s/MAIL_FROM_ADDRESS=/MAIL_FROM_ADDRESS=$MAIL_FROM_ADDRESS/g" .env
    sed -i "s/MAIL_FROM_NAME=/MAIL_FROM_NAME='$MAIL_FROM_NAME'/g" .env

    # monitoring
    sed -i "s/SENTRY_LARAVEL_DSN=/SENTRY_LARAVEL_DSN=$SENTRY_LARAVEL_DSN/g" .env

    # admin migration service variables
    sed -i "s/MIGRATION_SERVICE_CLIENT_ID=/MIGRATION_SERVICE_CLIENT_ID=$MIGRATION_SERVICE_CLIENT_ID/g" .env
    sed -i "s/MIGRATION_SERVICE_CLIENT_SECRET=/MIGRATION_SERVICE_CLIENT_SECRET=$MIGRATION_SERVICE_CLIENT_SECRET/g" .env
    sed -i "s/MIGRATION_SERVICE_CLIENT_ENDPOINT=/MIGRATION_SERVICE_CLIENT_ENDPOINT=$MIGRATION_SERVICE_CLIENT_ENDPOINT/g" .env

    # tiarra sms variables
    sed -i "s/TIARRA_SENDER_ID=/TIARRA_SENDER_ID=$TIARRA_SENDER_ID/g" .env
    sed -i "s/TIARRA_API_KEY=/TIARRA_API_KEY=$TIARRA_API_KEY/g" .env
    sed -i "s/TIARRA_ENDPOINT=/TIARRA_ENDPOINT=$TIARRA_ENDPOINT/g" .env

    # firebase cloud messaging variables
    sed -i "s/FIREBASE_DATABASE_URL=/FIREBASE_DATABASE_URL=$FIREBASE_DATABASE_URL/g" .env

    # create a new file - google-cloud.json
    echo $FIREBASE_CREDENTIALS | base64 -d > fcmaccount.json

fi

# execute
exec "$@"