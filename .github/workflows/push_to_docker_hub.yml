name: Push to google cloud registry

on:
  release:
    types: [published]

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REPO_NAME: ${{ secrets.REPO_NAME }}
    
    steps:
    - uses: actions/checkout@v2

    # Authenticate with Google Cloud
    - id: authenticate
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCLOUD_AUTH }}

    #Setup Cloud CLI
    - name: Cloud CLI
      uses: google-github-actions/setup-gcloud@v2

    - name: Authenticate Docker
      run: |-
        gcloud auth configure-docker us-central1-docker.pkg.dev

    # get release tag version
    - name: Get release tag
      id: get_tag
      run: echo ::set-output name=tag::${GITHUB_REF/refs\/tags\//}

    # Build the Docker image
    - name: Build
      run: docker build -t us-central1-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$REPO_NAME:${{ steps.get_tag.outputs.tag }} .

    # Push the Docker image
    - name: Push
      run: docker push us-central1-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$REPO_NAME:${{ steps.get_tag.outputs.tag }}
